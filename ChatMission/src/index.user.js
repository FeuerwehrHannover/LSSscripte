// ==UserScript==
// @name         ChatMission
// @version      1.2
// @author       FeuerwehrHannover
// @include      *://www.leitstellenspiel.de/
// @description  Zeigt eine Vorschau des Einsatzes bei einer Rückmeldung im Verbandschat
// ==/UserScript==

$(document).ready(function(){if($("#chat_panel_heading div.btn-group").append('<button class="btn btn-default btn-xs" id="chatmission-move-btn"><span class="glyphicon glyphicon-move"></span></button>'),$('<div id="chatmission"></div>').appendTo("body").css({position:"fixed","background-color":"#f5f5f5",width:"400px","-webkit-box-shadow":"0px 0px 18px 1px rgba(71,71,71,0.54)","-moz-box-shadow":"0px 0px 18px 1px rgba(71,71,71,0.54)","box-shadow":"0px 0px 10px 1px rgba(71,71,71,0.54)","border-radius":"3px",display:"none","z-index":"20010"}),null!==localStorage.getItem("ChatMission_pos_t_b_key")&&null!==localStorage.getItem("ChatMission_pos_t_b_val")&&null!==localStorage.getItem("ChatMission_pos_r_l_key")&&null!==localStorage.getItem("ChatMission_pos_r_l_val")){if("top"==localStorage.getItem("ChatMission_pos_t_b_key")){var s=localStorage.getItem("ChatMission_pos_t_b_val")+"px";$("#chatmission").css("top",s)}else{s=localStorage.getItem("ChatMission_pos_t_b_val")+"px";$("#chatmission").css("bottom",s)}if("left"==localStorage.getItem("ChatMission_pos_r_l_key")){var t=localStorage.getItem("ChatMission_pos_r_l_val")+"px";$("#chatmission").css("left",t)}else{t=localStorage.getItem("ChatMission_pos_r_l_val")+"px";$("#chatmission").css("right",t)}}else $("#chatmission").css({bottom:"50px",right:"45px"});$(document).on("mouseover",$("#mission_chat_messages"),function(s){var t=$(s.target);t.is("a")&&t.attr("href").match("^/missions/")&&1==t.parents("#mission_chat_messages").length&&function(s){if("/alliance_chats"!=s){var t=s.replace("/missions/",""),i=$("#mission_"+t);if(i.length>0){i.find("a.map_position_mover small s").remove();var o=i.find("a.map_position_mover small").text(),e=i.find("a.map_position_mover").text().replace(", "+o,""),a="label-danger",n="progress-bar-danger",l="<div>";if(i.children(".panel").hasClass("mission_panel_green")?(a="label-success",n="progress-bar-success"):i.children(".panel").hasClass("mission_panel_yellow")&&(a="label-warning"),$("#chatmission").append('<span class="label '+a+'" style="display: block;">'+e+'</span><div class="progress" style="background-color:white;margin-bottom: 1px;"><div class="missionchat-progress progress-bar '+n+'" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" style="width: 20%"><span class="sr-only">20% abgeschlossen</span></div></div>'),$(".missionchat-progress").css("margin-top","2px"),"Ein Fahrzeug hat einen Sprechwunsch!"==$("#mission_missing_short_"+t).text&&(l+="<span class='label label-danger'>Sprechwunsch</span> "),$("#mission_patients_"+t).length>0)if($("#mission_patient_summary_"+t).length>0)l+="<span class='label label-primary'>"+$("#mission_patient_summary_"+t).children("strong").text()+"</span> ",$("#mission_patient_summary_"+t+" .alert").each(function(){l+="<span class='label label-warning'>"+$(this).text().replace("Wir benötigen: ","")+"</span> "});else if($("#mission_patients_"+t).length>0){var p=$("#mission_patients_"+t).children('div[id^="patient_"]').length,r=p-$("#mission_patients_"+t).children('div[id^="patient_"]').find(".progress-striped-inner-active").length;p>0&&(l+="<span class='label label-primary'> "+p+(p!=r?" ("+r+") ":" ")+(p>1?"Patienten":"Patient")+"</span> ")}l+="<span class='label label-info'><span class='glyphicon glyphicon-info-sign' aria-hidden='true'></span> "+o+"</span><br/></div>",$("#chatmission").append(l),$("#mission_missing_"+t).length>0&&""!=$("#mission_missing_"+t)&&$("#chatmission").append('<div class="chatmission-danger"><p style="margin: 0;">'+$("#mission_missing_"+t).text()+"</p></div>"),$(".chatmission-danger").css({"background-color":"rgb(255, 221, 221)","border-left":"6px solid rgb(244, 67, 54)","margin-top":"2px",padding:"4px 12px",display:"flex","align-items":"center"}),$("body").hasClass("dark")&&$(".chatmission-danger").css("color","black")}else $("#chatmission").append('<center><h1 style="color:white"><span class="glyphicon glyphicon-ok-circle"></span><br>Einsatz beendet</h1></center>'),$("#chatmission").css("background-color","#5CB85C");$("#chatmission").fadeIn("fast")}}(t.attr("href"))}),$(document).on("mouseout",$("#mission_chat_messages"),function(s){$("#chatmission").fadeOut("fast").empty().css("background-color","#f5f5f5")}),$(document).on("click","#chatmission-move-btn",function(s){if($("#chatmission-move-btn").hasClass("btn-default")){$("#chatmission-move-btn").removeClass("btn-default"),$("#chatmission-move-btn").addClass("btn-success"),$('<div id="chatmission-move"></div>').appendTo("body").css({position:"fixed","background-color":"#f5f5f5",right:"45px",bottom:"50px",width:"400px",height:"200px","-webkit-box-shadow":"0px 0px 18px 1px rgba(71,71,71,0.54)","-moz-box-shadow":"0px 0px 18px 1px rgba(71,71,71,0.54)","box-shadow":"0px 0px 10px 1px rgba(71,71,71,0.54)","border-radius":"3px","z-index":"20010",cursor:"move"}),$("#chatmission-move").append('<center><h1 style="color:white"><span class="glyphicon glyphicon-move"></span><br>Fenster an gewünschte Position schieben und Button betätigen</h1></center>'),$("#chatmission-move").css("background-color","#337AB7"),$("#chatmission-move").on("mousedown",function(s){var t=$(this).addClass("drag").css("cursor","move");height=t.outerHeight(),width=t.outerWidth(),max_left=t.parent().offset().left+t.parent().width()-t.width(),max_top=t.parent().offset().top+t.parent().height()-t.height(),min_left=t.parent().offset().left,min_top=t.parent().offset().top,ypos=t.offset().top+height-s.pageY,xpos=t.offset().left+width-s.pageX,$(document.body).on("mousemove",function(s){var i=s.pageY+ypos-height,o=s.pageX+xpos-width;t.hasClass("drag")&&(i<=min_top&&(i=min_top),o<=min_left&&(o=min_left),i>=max_top&&(i=max_top),o>=max_left&&(o=max_left),t.offset({top:i,left:o}))}).on("mouseup",function(s){t.removeClass("drag")})})}else{var t=$("#chatmission-move").position();$("#chatmission").css({top:"",bottom:"",left:"",right:""});var i="",o="",e="",a="";t.top<$(window).height()/2?(i="top",o=t.top,$("#chatmission").css("top",t.top+"px")):(i="bottom",o=$(window).height()-t.top-$("#chatmission-move").height(),$("#chatmission").css("bottom",$(window).height()-t.top-$("#chatmission-move").height()+"px")),t.left<$(window).width()/2?(e="left",a=t.left,$("#chatmission").css("left",t.left+"px")):(e="right",$("#chatmission").css("right",$(window).width()-t.left-$("#chatmission-move").width()+"px"),a=$(window).width()-t.left-$("#chatmission-move").width()),localStorage.setItem("ChatMission_pos_t_b_key",i),localStorage.setItem("ChatMission_pos_t_b_val",o),localStorage.setItem("ChatMission_pos_r_l_key",e),localStorage.setItem("ChatMission_pos_r_l_val",a),$("#chatmission-move").remove(),$("#chatmission-move-btn").addClass("btn-default"),$("#chatmission-move-btn").removeClass("btn-success")}})});
